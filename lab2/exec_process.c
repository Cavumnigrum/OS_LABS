#include <stdio.h>      // Библиотека для стандартного ввода-вывода (printf)
#include <stdlib.h>     // Библиотека для system(), exit()
#include <unistd.h>     // Библиотека для fork(), getpid(), getppid(), execl(), sleep()
#include <sys/types.h>  // Определения типов данных для процессов (pid_t)
#include <sys/wait.h>   // Библиотека для wait() и waitpid()
#include <time.h>       // Библиотека для работы со временем (time, localtime, strftime)

// Функция для вывода текущего времени в формате "часы:минуты:секунды"
void print_time() {
    time_t t;
    struct tm *tm_info;
    char time_buffer[9];

    time(&t);                    // Получаем текущее время
    tm_info = localtime(&t);     // Преобразуем его в локальное время
    strftime(time_buffer, 9, "%H:%M:%S", tm_info); // Форматируем время в строку "чч:мм:сс"
    printf("Текущее время: %s\n", time_buffer);  // Выводим время на экран
}

int main() {
    pid_t pid1, pid2;  // Объявляем переменные для хранения идентификаторов процессов

    // Выводим информацию о родительском процессе
    printf("Родительский процесс: PID=%d, PPID=%d\n", getpid(), getppid());
    print_time();  // Выводим текущее время

    // Создаём первый дочерний процесс
    pid1 = fork();
    if (pid1 == 0) { // Если мы в дочернем процессе (fork вернул 0)
        printf("Первый дочерний процесс: PID=%d, PPID=%d\n", getpid(), getppid());
        print_time();

        // Выполняем команду "ls -l" через system(), чтобы вывести список файлов
        system("ls -l");

        exit(0);  // Завершаем работу первого дочернего процесса
    }

    // Создаём второй дочерний процесс
    pid2 = fork();
    if (pid2 == 0) { // Если мы во втором дочернем процессе (fork вернул 0)
        printf("Второй дочерний процесс: PID=%d, PPID=%d\n", getpid(), getppid());
        print_time();

        // Запускаем исполняемый файл "threads" с помощью exec()
        execl("./threads", "./threads", NULL);

        // Если exec() не сработает, выведем ошибку и завершим процесс
        perror("Ошибка exec");
        exit(1);
    }

    // Родительский процесс ждёт немного, чтобы дать время дочерним процессам выполнить код
    sleep(1);

    // Выводим список всех запущенных процессов в системе (включая созданные нами)
    printf("\nВывод команды ps -x:\n");
    system("ps -x");  // Выполняем команду ps -x (список всех процессов пользователя)

    // Ожидание завершения обоих дочерних процессов
    wait(NULL);  // Ожидание завершения первого дочернего процесса
    wait(NULL);  // Ожидание завершения второго дочернего процесса

    return 0;  // Завершаем выполнение программы
}
